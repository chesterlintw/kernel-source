From: Quinn Tran <quinn.tran@cavium.com>
Date: Fri, 15 Feb 2019 12:40:15 -0800
Subject: [PATCH] qla2xxx: allow irqbalance control in non-MQ mode
References: bsc#1128979
Patch-Mainline: never, SLE15 specific patch

For initiator mode, current code default to Blk-MQ to
control IRQ affinity.  This mode block irqbalance from
controlling IRQ setting.  This patch will see if Blk-MQ
is enabled or not before letting Blk-MQ control the IRQ
setting.

Signed-off-by: Quinn Tran <quinn.tran@cavium.com>
Acked-by: Hannes Reinecke <hare@suse.com>
---
 drivers/scsi/qla2xxx/qla_isr.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/scsi/qla2xxx/qla_isr.c b/drivers/scsi/qla2xxx/qla_isr.c
index 68989e9..cb52d54 100644
--- a/drivers/scsi/qla2xxx/qla_isr.c
+++ b/drivers/scsi/qla2xxx/qla_isr.c
@@ -3496,7 +3496,7 @@ qla24xx_enable_msix(struct qla_hw_data *ha, struct rsp_que *rsp)
 		min_vecs++;
 	}
 
-	if (USER_CTRL_IRQ(ha)) {
+	if (USER_CTRL_IRQ(ha) || !shost_use_blk_mq(vha->host)) {
 		/* user wants to control IRQ setting for target mode */
 		ret = pci_alloc_irq_vectors(ha->pdev, min_vecs,
 		    ha->msix_count, PCI_IRQ_MSIX);
-- 
1.8.3.1

