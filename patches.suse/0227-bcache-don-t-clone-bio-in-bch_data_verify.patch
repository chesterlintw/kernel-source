From c8b27acc775990bbd01f067ee7616f7abf2c98a1 Mon Sep 17 00:00:00 2001
From: Christoph Hellwig <hch@lst.de>
Date: Tue, 24 Jul 2018 09:52:30 +0200
Subject: [PATCH] bcache: don't clone bio in bch_data_verify
Git-commit: c8b27acc775990bbd01f067ee7616f7abf2c98a1
Patch-mainline: v4.19-rc1
References: bsc#1130972

We immediately overwrite the biovec array, so instead just allocate
a new bio and copy over the disk, setor and size.

(Coly Li: rebased for SLE15 kernel)

Signed-off-by: Christoph Hellwig <hch@lst.de>
Reviewed-by: Ming Lei <ming.lei@redhat.com>
Acked-by: Coly Li <colyli@suse.de>
Signed-off-by: Jens Axboe <axboe@kernel.dk>

---
 drivers/md/bcache/debug.c |    6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

--- a/drivers/md/bcache/debug.c
+++ b/drivers/md/bcache/debug.c
@@ -109,11 +109,15 @@ void bch_data_verify(struct cached_dev *
 	struct bio_vec bv, cbv;
 	struct bvec_iter iter, citer = { 0 };
 
-	check = bio_clone_kmalloc(bio, GFP_NOIO);
+	check = bio_kmalloc(GFP_NOIO, bio_segments(bio));
 	if (!check)
 		return;
+	check->bi_disk = bio->bi_disk;
 	check->bi_opf = REQ_OP_READ;
+	check->bi_iter.bi_sector = bio->bi_iter.bi_sector;
+	check->bi_iter.bi_size = bio->bi_iter.bi_size;
 
+	bch_bio_map(check, NULL);
 	if (bio_alloc_pages(check, GFP_NOIO))
 		goto out_put;
 
