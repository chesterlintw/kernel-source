From: Hannes Reinecke <hare@suse.de>
Date: Wed, 30 Jan 2019 10:12:58 +0100
Subject: [PATCH] bsg: allocate sense buffer if requested
References: bsc#1106811
Patch-Mainline: submitted linux-block 2019/01/30

The sense buffer of a bsg request is given in the 'response'
pointer, so if this is not set we shouldn't allocate one.
At the same time we need to allocate our own sense buffer as
it's no longer embedded in the SCSI command.

Fixes: 82ed4db499b8 ("block: split scsi_request out of struct request")

Signed-off-by: Hannes Reinecke <hare@suse.com>
---
 block/bsg.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/block/bsg.c b/block/bsg.c
index 37663b664666..02c99f437e75 100644
--- a/block/bsg.c
+++ b/block/bsg.c
@@ -151,9 +151,16 @@ static int blk_fill_sgv4_hdr_rq(struct request_queue *q, struct request *rq,
 			   hdr->request_len))
 		return -EFAULT;
 
+	if (hdr->response) {
+		req->sense = kzalloc(hdr->max_response_len, GFP_KERNEL);
+		if (!req->sense)
+			return -ENOMEM;
+	} else
+		req->sense = NULL;
+
 	if (hdr->subprotocol == BSG_SUB_PROTOCOL_SCSI_CMD) {
 		if (blk_verify_command(req->cmd, has_write_perm))
 			return -EPERM;
 	} else if (!capable(CAP_SYS_RAWIO))
 		return -EPERM;
 
@@ -434,6 +442,7 @@ static int blk_complete_sgv4_hdr_rq(struct request *rq, struct sg_io_v4 *hdr,
 		ret = req->result;
 
 	blk_rq_unmap_user(bio);
+	kfree(req->sense);
 	scsi_req_free_cmd(req);
 	blk_put_request(rq);
 
-- 
2.16.4

